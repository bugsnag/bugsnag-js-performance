const fs = require('fs')
const { resolve } = require('path')
const util = require('util')
const { execSync } = require('child_process')
const { ROOT_DIR } = require('./constants')
const { replaceInFile, safeCopyFile, removeFileIfExists } = require('./file-utils')

/**
 * Replace native files generated by react-native cli with pre-configured files
 */
function replaceGeneratedFixtureFiles (fixtureDir, isReactNativeNavigation) {
  // remove the stock App.js/tsx file
  const appTsFilePath = resolve(fixtureDir, 'App.tsx')
  const appJsFilePath = resolve(fixtureDir, 'App.js')
  removeFileIfExists(appTsFilePath)
  removeFileIfExists(appJsFilePath)

  // replace index.js with the appropriate entrypoint
  if (isReactNativeNavigation) {
    safeCopyFile(
      resolve(ROOT_DIR, 'test/react-native/features/fixtures/react-native-navigation/index.js'),
      resolve(fixtureDir, 'index.js')
    )
  } else {
    safeCopyFile(
      resolve(ROOT_DIR, 'test/react-native/features/fixtures/app/index.js'),
      resolve(fixtureDir, 'index.js')
    )
  }

  safeCopyFile(
    resolve(ROOT_DIR, 'test/react-native/features/fixtures/app/ios/exportOptions.plist'),
    resolve(fixtureDir, 'exportOptions.plist')
  )

  // Update babel config
  const babelConfig = require(resolve(fixtureDir, 'babel.config.js'))
  if (!babelConfig.plugins) babelConfig.plugins = []
  babelConfig.plugins.push('@babel/plugin-transform-export-namespace-from')
  fs.writeFileSync(resolve(fixtureDir, 'babel.config.js'), `module.exports = ${util.inspect(babelConfig)}`)
}



/**
 * Configure React Native Navigation (Wix)
 */
function configureReactNativeNavigation (fixtureDir) {
  execSync('npx rnn-link', { cwd: fixtureDir, stdio: 'inherit' })

  // update the kotlin version to 1.8.0 in the android build.gradle file (required for Android Performance)
  const gradlePath = resolve(fixtureDir, 'android/build.gradle')
  replaceInFile(gradlePath, /RNNKotlinVersion = "[^"]+"/, 'RNNKotlinVersion = "1.8.0"')
}



module.exports = {
  replaceGeneratedFixtureFiles,
  configureReactNativeNavigation
}
