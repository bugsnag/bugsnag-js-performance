const fs = require('fs')
const { resolve } = require('path')
const util = require('util')
const { execSync } = require('child_process')
const { ROOT_DIR } = require('./constants')
const { replaceInFile, safeCopyFile, removeFileIfExists, appendToFileIfNotExists } = require('./file-utils')

/**
 * Replace native files generated by react-native cli with pre-configured files
 */
function replaceGeneratedFixtureFiles (fixtureDir, isReactNativeNavigation) {
  // remove the stock App.js/tsx file
  const appTsFilePath = resolve(fixtureDir, 'App.tsx')
  const appJsFilePath = resolve(fixtureDir, 'App.js')
  removeFileIfExists(appTsFilePath)
  removeFileIfExists(appJsFilePath)

  // replace index.js with the appropriate entrypoint
  if (isReactNativeNavigation) {
    safeCopyFile(
      resolve(ROOT_DIR, 'test/react-native/features/fixtures/react-native-navigation/index.js'),
      resolve(fixtureDir, 'index.js')
    )
  } else {
    safeCopyFile(
      resolve(ROOT_DIR, 'test/react-native/features/fixtures/app/index.js'),
      resolve(fixtureDir, 'index.js')
    )
  }

  safeCopyFile(
    resolve(ROOT_DIR, 'test/react-native/features/fixtures/app/ios/exportOptions.plist'),
    resolve(fixtureDir, 'exportOptions.plist')
  )

  // Update babel config
  const babelConfig = require(resolve(fixtureDir, 'babel.config.js'))
  if (!babelConfig.plugins) babelConfig.plugins = []
  babelConfig.plugins.push('@babel/plugin-transform-export-namespace-from')
  fs.writeFileSync(resolve(fixtureDir, 'babel.config.js'), `module.exports = ${util.inspect(babelConfig)}`)
}

/**
 * Configure iOS project settings
 */
function configureIOSProject (fixtureDir, reactNativeVersion) {
  // disable Flipper
  let podfileContents = fs.readFileSync(`${fixtureDir}/ios/Podfile`, 'utf8')
  if (podfileContents.includes('use_flipper!')) {
    podfileContents = podfileContents.replace(/use_flipper!/, '# use_flipper!')
  } else if (podfileContents.includes(':flipper_configuration')) {
    podfileContents = podfileContents.replace(/:flipper_configuration/, '# :flipper_configuration')
  }

  // for RN versions < 0.73, bump the minimum iOS version to 13 (required for Cocoa Performance)
  if (parseFloat(reactNativeVersion) < 0.73) {
    podfileContents = podfileContents.replace(/platform\s*:ios,\s*(?:'[\d.]+'|min_ios_version_supported)/, "platform :ios, '13.0'")
  }

  fs.writeFileSync(`${fixtureDir}/ios/Podfile`, podfileContents)

  // pin xcodeproj version to < 1.26.0
  const gemfilePath = resolve(fixtureDir, 'Gemfile')
  if (fs.existsSync(gemfilePath)) {
    appendToFileIfNotExists(gemfilePath, "gem 'xcodeproj', '< 1.26.0'", 'xcodeproj')
    appendToFileIfNotExists(gemfilePath, "gem 'concurrent-ruby', '<= 1.3.4'", 'concurrent-ruby')
  }

  // set NSAllowsArbitraryLoads to allow http traffic for all domains (bitbar public IP + bs-local.com)
  const plistpath = `${fixtureDir}/ios/reactnative/Info.plist`
  let plistContents = fs.readFileSync(plistpath, 'utf8')
  const allowArbitraryLoads = '<key>NSAllowsArbitraryLoads</key>\n\t\t<true/>'
  let searchPattern, replacement
  if (plistContents.includes('<key>NSAllowsArbitraryLoads</key>')) {
    searchPattern = '<key>NSAllowsArbitraryLoads</key>\n\t\t<false/>'
    replacement = allowArbitraryLoads
  } else {
    searchPattern = '<key>NSAppTransportSecurity</key>\n\t<dict>'
    replacement = `${searchPattern}\n\t\t${allowArbitraryLoads}`
  }

  // remove the NSAllowsLocalNetworking key if it exists as this causes NSAllowsArbitraryLoads to be ignored
  const allowLocalNetworking = '<key>NSAllowsLocalNetworking</key>\n\t\t<true/>'
  plistContents = plistContents.replace(allowLocalNetworking, '')

  fs.writeFileSync(plistpath, plistContents.replace(searchPattern, replacement))
}

/**
 * Configure Android project settings
 */
function configureAndroidProject (fixtureDir, isNewArchEnabled, reactNativeVersion) {
  // set android:usesCleartextTraffic="true" in AndroidManifest.xml
  const androidManifestPath = `${fixtureDir}/android/app/src/main/AndroidManifest.xml`
  replaceInFile(androidManifestPath, '<application', '<application android:usesCleartextTraffic="true"')

  // enable/disable the new architecture in gradle.properties
  const gradlePropertiesPath = `${fixtureDir}/android/gradle.properties`
  replaceInFile(gradlePropertiesPath, /newArchEnabled\s*=\s*(true|false)/, `newArchEnabled=${isNewArchEnabled}`)

  if (!isNewArchEnabled) {
    // react navigation setup
    configureReactNavigationAndroid(fixtureDir, reactNativeVersion)
  }
}

/**
 * Configure React Navigation for Android
 */
function configureReactNavigationAndroid (fixtureDir, reactNativeVersion) {
  const fileExtension = parseFloat(reactNativeVersion) < 0.73 ? 'java' : 'kt'
  let mainActivityPattern, mainActivityReplacement
  if (fileExtension === 'java') {
    mainActivityPattern = 'public class MainActivity extends ReactActivity {'
    mainActivityReplacement = `
import android.os.Bundle;

public class MainActivity extends ReactActivity {

  /**
   * Required for react-navigation/native implementation
   * https://reactnavigation.org/docs/getting-started/#installing-dependencies-into-a-bare-react-native-project
   */
  @Override
  protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(null);
  }
`
  } else if (fileExtension === 'kt') {
    mainActivityPattern = 'class MainActivity : ReactActivity() {'
    mainActivityReplacement = `
import android.os.Bundle

class MainActivity : ReactActivity() {

  /**
   * Required for react-navigation/native implementation
   * https://reactnavigation.org/docs/getting-started/#installing-dependencies-into-a-bare-react-native-project
   */
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(null)
  }
`
  }

  const mainActivityPath = `${fixtureDir}/android/app/src/main/java/com/bugsnag/fixtures/reactnative/performance/MainActivity.${fileExtension}`
  replaceInFile(mainActivityPath, mainActivityPattern, mainActivityReplacement)
}

/**
 * Install Android Performance dependency
 */
function installAndroidPerformance (fixtureDir) {
  const appGradlePath = resolve(fixtureDir, 'android/app/build.gradle')
  const performanceDependency = 'implementation("com.bugsnag:bugsnag-android-performance:1.16.0")'
  const dependenciesSection = 'dependencies {'

  replaceInFile(appGradlePath, dependenciesSection, `${dependenciesSection}\n    ${performanceDependency}`)
}

function installNativeTestUtilsAndroid(fixtureDir) {
  const appGradlePath = resolve(fixtureDir, 'android/app/build.gradle')
  const testUtilsDependency = 'implementation project(":bugsnag-test-utils")'
  const dependenciesSection = 'dependencies {'

  replaceInFile(appGradlePath, dependenciesSection, `${dependenciesSection}\n    ${testUtilsDependency}`)

  const settingsGradlePath = resolve(fixtureDir, 'android/settings.gradle')
  const includeDependency = 'include("bugsnag-test-utils")'
  const dependencyPath = `project(":bugsnag-test-utils").projectDir = file("${resolve(ROOT_DIR, 'test/react-native/native-test-utils/android')}")`

  appendToFileIfNotExists(settingsGradlePath, `\n${includeDependency}\n${dependencyPath}`, 'bugsnag-test-utils')
}

function installNativeTestUtilsIOS(fixtureDir) {
  const podfilePath = resolve(fixtureDir, 'ios/Podfile')
  const testUtilsPod = `pod 'BugsnagTestUtils', :path => '${resolve(ROOT_DIR, 'test/react-native/native-test-utils/ios/BugsnagTestUtils.podspec')}'`
  const targetSection = 'target \'reactnative\' do'
  
  replaceInFile(podfilePath, targetSection, `${targetSection}\n  ${testUtilsPod}`)
}

/**
 * Install Cocoa Performance dependency
 */
function installCocoaPerformance (fixtureDir) {
  const podfilePath = resolve(fixtureDir, 'ios/Podfile')
  const performancePod = "pod 'BugsnagPerformance'"
  const targetSection = 'target \'reactnative\' do'

  replaceInFile(podfilePath, targetSection, `${targetSection}\n  ${performancePod}`)
}

/**
 * Configure React Native Navigation (Wix)
 */
function configureReactNativeNavigation (fixtureDir) {
  execSync('npx rnn-link', { cwd: fixtureDir, stdio: 'inherit' })

  // update the kotlin version to 1.8.0 in the android build.gradle file (required for Android Performance)
  const gradlePath = resolve(fixtureDir, 'android/build.gradle')
  replaceInFile(gradlePath, /RNNKotlinVersion = "[^"]+"/, 'RNNKotlinVersion = "1.8.0"')
}

/**
 * Configure MainApplication to import BugsnagTestUtils and call startNativePerformance
 */
function configureMainApplicationForTestUtils (fixtureDir, reactNativeVersion) {
  const fileExtension = parseFloat(reactNativeVersion) < 0.73 ? 'java' : 'kt'
  const mainApplicationPath = `${fixtureDir}/android/app/src/main/java/com/bugsnag/fixtures/reactnative/performance/MainApplication.${fileExtension}`
  
  if (!fs.existsSync(mainApplicationPath)) {
    console.warn(`MainApplication file not found at ${mainApplicationPath}`)
    return
  }
  
  let fileContents = fs.readFileSync(mainApplicationPath, 'utf8')
  
  if (fileExtension === 'java') {
    // Add import for Java files
    const importStatement = 'import com.bugsnag.test.utils.BugsnagTestUtils;'
    if (!fileContents.includes(importStatement)) {
      // Find the last import statement and add our import after it
      const lastImportMatch = fileContents.match(/import\s+[^;]+;/g)
      if (lastImportMatch) {
        const lastImport = lastImportMatch[lastImportMatch.length - 1]
        fileContents = fileContents.replace(lastImport, `${lastImport}\n${importStatement}`)
      }
    }
    
    // Add BugsnagTestUtils.startNativePerformanceIfConfigured() call after super.onCreate()
    const methodCallPattern = /super\.onCreate\(\);/
    const methodCall = 'BugsnagTestUtils.startNativePerformanceIfConfigured(this);'
    if (methodCallPattern.test(fileContents) && !fileContents.includes(methodCall)) {
      fileContents = fileContents.replace(methodCallPattern, `super.onCreate();\n    ${methodCall}`)
    }
  } else {
    // Add import for Kotlin files
    const importStatement = 'import com.bugsnag.test.utils.BugsnagTestUtils'
    if (!fileContents.includes(importStatement)) {
      // Find the last import statement and add our import after it
      const lastImportMatch = fileContents.match(/import\s+[^\n]+/g)
      if (lastImportMatch) {
        const lastImport = lastImportMatch[lastImportMatch.length - 1]
        fileContents = fileContents.replace(lastImport, `${lastImport}\n${importStatement}`)
      }
    }
    
    // Add BugsnagTestUtils.startNativePerformanceIfConfigured() call after super.onCreate()
    const methodCallPattern = /super\.onCreate\(\)/
    const methodCall = 'BugsnagTestUtils.startNativePerformanceIfConfigured(this)'
    if (methodCallPattern.test(fileContents) && !fileContents.includes(methodCall)) {
      fileContents = fileContents.replace(methodCallPattern, `super.onCreate()\n    ${methodCall}`)
    }
  }
  
  fs.writeFileSync(mainApplicationPath, fileContents)
}

/**
 * Configure AppDelegate to import BugsnagTestUtils and call startNativePerformance
 */
function configureAppDelegateForTestUtils (fixtureDir, reactNativeVersion) {
  // Determine file type based on React Native version
  const isSwift = parseFloat(reactNativeVersion) >= 0.78
  const fileExtension = isSwift ? 'swift' : (parseFloat(reactNativeVersion) >= 0.72 ? 'mm' : 'm')
  const appDelegatePath = `${fixtureDir}/ios/reactnative/AppDelegate.${fileExtension}`
  
  if (!fs.existsSync(appDelegatePath)) {
    console.warn(`AppDelegate file not found at ${appDelegatePath}`)
    return
  }
  
  let fileContents = fs.readFileSync(appDelegatePath, 'utf8')
  
  if (isSwift) {
    // Add import for Swift files
    const importStatement = 'import BugsnagTestUtils'
    if (!fileContents.includes(importStatement)) {
      // Find the last import statement and add our import after it
      const lastImportMatch = fileContents.match(/import\s+[^\n]+/g)
      if (lastImportMatch) {
        const lastImport = lastImportMatch[lastImportMatch.length - 1]
        fileContents = fileContents.replace(lastImport, `${lastImport}\n${importStatement}`)
      }
    }
    
    // Add BugsnagTestUtils.startNativePerformanceIfConfigured() call in didFinishLaunchingWithOptions
    const methodCall = 'BugsnagTestUtils.startNativePerformanceIfConfigured()'
    if (!fileContents.includes(methodCall)) {
      // For 0.78 pattern: find after self.initialProps = [:]
      if (fileContents.includes('self.initialProps = [:]')) {
        const pattern = /self\.initialProps = \[:]/
        fileContents = fileContents.replace(pattern, `self.initialProps = [:]\n\n    ${methodCall}`)
      }
      // For 0.79+ pattern: find after delegate.dependencyProvider = RCTAppDependencyProvider()
      else if (fileContents.includes('delegate.dependencyProvider = RCTAppDependencyProvider()')) {
        const pattern = /delegate\.dependencyProvider = RCTAppDependencyProvider\(\)/
        fileContents = fileContents.replace(pattern, `delegate.dependencyProvider = RCTAppDependencyProvider()\n\n    ${methodCall}`)
      }
    }
  } else {
    // Add import for Objective-C files
    const importStatement = '#import <BugsnagTestUtils/BugsnagTestUtils.h>'
    if (!fileContents.includes(importStatement)) {
      // Add the import statement at the top of the file
      fileContents = `${importStatement}\n${fileContents}`
    }
    
    // Add [BugsnagTestUtils startNativePerformanceIfConfigured] call in didFinishLaunchingWithOptions
    const methodCall = '[BugsnagTestUtils startNativePerformanceIfConfigured];'
    if (!fileContents.includes(methodCall)) {
      // For .m files: find after #ifdef FB_SONARKIT_ENABLED block
      if (fileContents.includes('#ifdef FB_SONARKIT_ENABLED')) {
        const pattern = /(#ifdef FB_SONARKIT_ENABLED\s+InitializeFlipper\(application\);\s+#endif)/
        fileContents = fileContents.replace(pattern, `$1\n\n  ${methodCall}`)
      }
      // For .mm files: find after self.initialProps = @{};
      else if (fileContents.includes('self.initialProps = @{};')) {
        const pattern = /self\.initialProps = @\{\};/
        fileContents = fileContents.replace(pattern, `self.initialProps = @{};\n\n  ${methodCall}`)
      }
    }
  }
  
  fs.writeFileSync(appDelegatePath, fileContents)
}

module.exports = {
  replaceGeneratedFixtureFiles,
  configureIOSProject,
  configureAndroidProject,
  configureReactNavigationAndroid,
  installAndroidPerformance,
  installCocoaPerformance,
  configureReactNativeNavigation,
  installNativeTestUtilsAndroid,
  installNativeTestUtilsIOS,
  configureMainApplicationForTestUtils,
  configureAppDelegateForTestUtils
}
