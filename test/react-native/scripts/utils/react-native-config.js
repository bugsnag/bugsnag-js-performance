const fs = require('fs')
const { resolve } = require('path')
const util = require('util')
const { execSync } = require('child_process')
const { ROOT_DIR } = require('./constants')
const { replaceInFile, safeCopyFile, removeFileIfExists, appendToFileIfNotExists } = require('./file-utils')

/**
 * Replace native files generated by react-native cli with pre-configured files
 */
function replaceGeneratedFixtureFiles (fixtureDir, isReactNativeNavigation) {
  // remove the stock App.js/tsx file
  const appTsFilePath = resolve(fixtureDir, 'App.tsx')
  const appJsFilePath = resolve(fixtureDir, 'App.js')
  removeFileIfExists(appTsFilePath)
  removeFileIfExists(appJsFilePath)

  // replace index.js with the appropriate entrypoint
  if (isReactNativeNavigation) {
    safeCopyFile(
      resolve(ROOT_DIR, 'test/react-native/features/fixtures/react-native-navigation/index.js'),
      resolve(fixtureDir, 'index.js')
    )
  } else {
    safeCopyFile(
      resolve(ROOT_DIR, 'test/react-native/features/fixtures/app/index.js'),
      resolve(fixtureDir, 'index.js')
    )
  }

  safeCopyFile(
    resolve(ROOT_DIR, 'test/react-native/features/fixtures/app/ios/exportOptions.plist'),
    resolve(fixtureDir, 'exportOptions.plist')
  )

  // Update babel config
  const babelConfig = require(resolve(fixtureDir, 'babel.config.js'))
  if (!babelConfig.plugins) babelConfig.plugins = []
  babelConfig.plugins.push('@babel/plugin-transform-export-namespace-from')
  fs.writeFileSync(resolve(fixtureDir, 'babel.config.js'), `module.exports = ${util.inspect(babelConfig)}`)
}

/**
 * Configure iOS project settings
 */
function configureIOSProject (fixtureDir, reactNativeVersion) {
  // disable Flipper
  let podfileContents = fs.readFileSync(`${fixtureDir}/ios/Podfile`, 'utf8')
  if (podfileContents.includes('use_flipper!')) {
    podfileContents = podfileContents.replace(/use_flipper!/, '# use_flipper!')
  } else if (podfileContents.includes(':flipper_configuration')) {
    podfileContents = podfileContents.replace(/:flipper_configuration/, '# :flipper_configuration')
  }

  // for RN versions < 0.73, bump the minimum iOS version to 13 (required for Cocoa Performance)
  if (parseFloat(reactNativeVersion) < 0.73) {
    podfileContents = podfileContents.replace(/platform\s*:ios,\s*(?:'[\d.]+'|min_ios_version_supported)/, "platform :ios, '13.0'")
  }

  fs.writeFileSync(`${fixtureDir}/ios/Podfile`, podfileContents)

  // pin xcodeproj version to < 1.26.0
  const gemfilePath = resolve(fixtureDir, 'Gemfile')
  if (fs.existsSync(gemfilePath)) {
    appendToFileIfNotExists(gemfilePath, "gem 'xcodeproj', '< 1.26.0'", 'xcodeproj')
    appendToFileIfNotExists(gemfilePath, "gem 'concurrent-ruby', '<= 1.3.4'", 'concurrent-ruby')
  }

  // set NSAllowsArbitraryLoads to allow http traffic for all domains (bitbar public IP + bs-local.com)
  const plistpath = `${fixtureDir}/ios/reactnative/Info.plist`
  let plistContents = fs.readFileSync(plistpath, 'utf8')
  const allowArbitraryLoads = '<key>NSAllowsArbitraryLoads</key>\n\t\t<true/>'
  let searchPattern, replacement
  if (plistContents.includes('<key>NSAllowsArbitraryLoads</key>')) {
    searchPattern = '<key>NSAllowsArbitraryLoads</key>\n\t\t<false/>'
    replacement = allowArbitraryLoads
  } else {
    searchPattern = '<key>NSAppTransportSecurity</key>\n\t<dict>'
    replacement = `${searchPattern}\n\t\t${allowArbitraryLoads}`
  }

  // remove the NSAllowsLocalNetworking key if it exists as this causes NSAllowsArbitraryLoads to be ignored
  const allowLocalNetworking = '<key>NSAllowsLocalNetworking</key>\n\t\t<true/>'
  plistContents = plistContents.replace(allowLocalNetworking, '')

  fs.writeFileSync(plistpath, plistContents.replace(searchPattern, replacement))
}

/**
 * Configure Android project settings
 */
function configureAndroidProject (fixtureDir, isNewArchEnabled, reactNativeVersion) {
  // set android:usesCleartextTraffic="true" in AndroidManifest.xml
  const androidManifestPath = `${fixtureDir}/android/app/src/main/AndroidManifest.xml`
  replaceInFile(androidManifestPath, '<application', '<application android:usesCleartextTraffic="true"')

  // enable/disable the new architecture in gradle.properties
  const gradlePropertiesPath = `${fixtureDir}/android/gradle.properties`
  replaceInFile(gradlePropertiesPath, /newArchEnabled\s*=\s*(true|false)/, `newArchEnabled=${isNewArchEnabled}`)

  if (!isNewArchEnabled) {
    // react navigation setup
    configureReactNavigationAndroid(fixtureDir, reactNativeVersion)
  }
}

/**
 * Configure React Navigation for Android
 */
function configureReactNavigationAndroid (fixtureDir, reactNativeVersion) {
  const fileExtension = parseFloat(reactNativeVersion) < 0.73 ? 'java' : 'kt'
  let mainActivityPattern, mainActivityReplacement
  if (fileExtension === 'java') {
    mainActivityPattern = 'public class MainActivity extends ReactActivity {'
    mainActivityReplacement = `
import android.os.Bundle;

public class MainActivity extends ReactActivity {

  /**
   * Required for react-navigation/native implementation
   * https://reactnavigation.org/docs/getting-started/#installing-dependencies-into-a-bare-react-native-project
   */
  @Override
  protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(null);
  }
`
  } else if (fileExtension === 'kt') {
    mainActivityPattern = 'class MainActivity : ReactActivity() {'
    mainActivityReplacement = `
import android.os.Bundle

class MainActivity : ReactActivity() {

  /**
   * Required for react-navigation/native implementation
   * https://reactnavigation.org/docs/getting-started/#installing-dependencies-into-a-bare-react-native-project
   */
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(null)
  }
`
  }

  const mainActivityPath = `${fixtureDir}/android/app/src/main/java/com/bugsnag/fixtures/reactnative/performance/MainActivity.${fileExtension}`
  replaceInFile(mainActivityPath, mainActivityPattern, mainActivityReplacement)
}

/**
 * Install Android Performance dependency
 */
function installAndroidPerformance (fixtureDir) {
  const appGradlePath = resolve(fixtureDir, 'android/app/build.gradle')
  const performanceDependency = 'implementation("com.bugsnag:bugsnag-android-performance:1.16.0")'
  const dependenciesSection = 'dependencies {'

  replaceInFile(appGradlePath, dependenciesSection, `${dependenciesSection}\n    ${performanceDependency}`)
}

function installNativeTestUtilsAndroid(fixtureDir) {
  const appGradlePath = resolve(fixtureDir, 'android/app/build.gradle')
  const testUtilsDependency = 'implementation project(":bugsnag-test-utils")'
  const dependenciesSection = 'dependencies {'

  replaceInFile(appGradlePath, dependenciesSection, `${dependenciesSection}\n    ${testUtilsDependency}`)

  const settingsGradlePath = resolve(fixtureDir, 'android/settings.gradle')
  const includeDependency = 'include("bugsnag-test-utils")'
  const dependencyPath = `project(":bugsnag-test-utils").projectDir = file("${resolve(ROOT_DIR, 'test/react-native/native-test-utils/android')}")`

  appendToFileIfNotExists(settingsGradlePath, `\n${includeDependency}\n${dependencyPath}`, 'bugsnag-test-utils')
}

function installNativeTestUtilsIOS(fixtureDir) {
  const podfilePath = resolve(fixtureDir, 'ios/Podfile')
  const testUtilsPod = `pod 'BugsnagTestUtils', :path => '${resolve(ROOT_DIR, 'test/react-native/native-test-utils/ios/BugsnagTestUtils.podspec')}'`
  const targetSection = 'target \'reactnative\' do'
  
  replaceInFile(podfilePath, targetSection, `${targetSection}\n  ${testUtilsPod}`)
}

/**
 * Install Cocoa Performance dependency
 */
function installCocoaPerformance (fixtureDir) {
  const podfilePath = resolve(fixtureDir, 'ios/Podfile')
  const performancePod = "pod 'BugsnagPerformance'"
  const targetSection = 'target \'reactnative\' do'

  replaceInFile(podfilePath, targetSection, `${targetSection}\n  ${performancePod}`)
}

/**
 * Configure React Native Navigation (Wix)
 */
function configureReactNativeNavigation (fixtureDir) {
  execSync('npx rnn-link', { cwd: fixtureDir, stdio: 'inherit' })

  // update the kotlin version to 1.8.0 in the android build.gradle file (required for Android Performance)
  const gradlePath = resolve(fixtureDir, 'android/build.gradle')
  replaceInFile(gradlePath, /RNNKotlinVersion = "[^"]+"/, 'RNNKotlinVersion = "1.8.0"')
}

module.exports = {
  replaceGeneratedFixtureFiles,
  configureIOSProject,
  configureAndroidProject,
  configureReactNavigationAndroid,
  installAndroidPerformance,
  installCocoaPerformance,
  configureReactNativeNavigation,
  installNativeTestUtilsAndroid,
  installNativeTestUtilsIOS
}
