import traceIdToSamplingRate from '../lib/trace-id-to-sampling-rate'
import { randomBytes } from 'crypto'

describe('traceIdToSamplingRate', () => {
  it.each([
    ['aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa', 0],
    ['ffffffffffffffffffffffffffffffff', 0],
    ['0123456789abcdef0123456789abcdef', 0],
    ['0123456789abcdeffedcba9876543210', 0],
    ['a0b1c2d3e4f5a0b1c2d3e4f5a0b1c2d3', 640042052],
    ['3d2c1b0a5f4e3d2c1b0a5f4e3d2c1b0a', 1145332322],
    ['a5c97139dea3c7e96969f60a61bf092c', 1941719542],
    ['32c20564ee2861c8dee44e875cb77b3d', 1589203222],
    ['e601fedf62ec381abccfdadb123512e2', 706154236],
    ['881f27313ad4fc0727c2a9f59caaa1eb', 161731368],
    ['222b12f950cf07521084eea9e985005a', 2347105112],
    ['acb9366534aee4a7fa1143fcaf7e2105', 3447238715],
    ['40f6564fd1ce2ad3caef41d8206fc9e8', 2075718828],
    ['7eb23db1d1456caa839b662f3729d23c', 457565448],
    ['cf8217135aac9f6082adf45f9c31e2e0', 2343739084],
    ['401185ed50bf71348fa6c6202f85cf11', 2962095592],
    ['5fdd74e5ece23e611796560a170744bc', 3014547506],
    ['c74b46ac3c6e313d6b3189c49b835003', 194489942],
    ['3c2a7e89652b25d95b2319753ea2669d', 1015030968],
    ['19c292f772bd34220f599df90a6c4873', 1850372959],
    ['0956ef6d9f2425d5c1ebba986f17b4fc', 948880604],
    ['85264c40738954fa72bbfe485d1d61ab', 3641280345],
    ['abfab2fe8075d159d5376415f56a75a0', 198341138],
    ['a9b25572803d00abb03976318ef080ad', 390505285],
    ['d26d2742ee828624a7912bb212eda021', 2308123381],
    ['2fac64cc14e8752e525b0fbd38a3a77b', 1371322660],
    ['dcbd6832526790f3dae875b4be16b452', 3928242471],
    ['ef533b1fee52cae4ee4aff85e61080ad', 156995283],
    ['4b0f43f3dcb9142fa27f49aba98bc6c1', 2621626550],
    ['53eff5080f5a7ee251c686459fd59cd7', 2460389752],
    ['c4e5f8ffb0a47fcba8ca046b171c35d1', 3415717518],
    ['05fb085b301d09b2c302b9a8c6debf0b', 809109322],
    ['22a3f992769271d089bcec29c5dc3058', 407983155],
    ['b700402608fa550aa09d6280d11c6021', 3464173453],
    ['2f988ec68f8775e5ca3a63345dbd6e98', 932771471],
    ['ee4854a86647d24b0accab19330fa64d', 2982972343],
    ['d16ea83092c1c405dcd27cb23501995a', 2860288477],
    ['aa0e519f34ce72e0a654451a56148f4e', 1853942059],
    ['1003640115e4159accc8ec6b605d05aa', 2842859610],
    ['82e137472bd881769aecbdba57b78a70', 1684177403],
    ['7ed94fdcdcba6979315860e06968ad3b', 4199803774],
    ['37f6c9f0061abab6247b5e3db4a76ff5', 2704294542],
    ['9cdf24652fc526ab31f2d619d74a7542', 1436721557],
    ['31463f435efbbd674da12bf7840593bb', 2786671208],
    ['a6959353ce051976952cfa00dfe1f3e9', 576553932],
    ['23652736122a3b5a03d127ccd3c78670', 3780754896],
    ['16b8dbfeffbe6c9920f79119e923533c', 550663490],
    ['762104b2ea9ee143078b9137301a2306', 2871941056],
    ['13bc2ca729cb6508c155d24696a4907b', 1837501330],
    ['6bf00610e0044952923c37a370af8dd8', 1768420665],
    ['008f54482144eafb7141aa8332585191', 1657947553],
    ['fe9764c018f6a27426de565046a4abc8', 2249931564],
    ['d4cdb66b2ff10e54948e8d57ef9c82ff', 2150545303],
    ['35dcc745e618cb167c8e22387a46b481', 3574373098],
    ['edd58d7f48f1f3377375ea70e19331bb', 935503235],
    ['ae481e400299e86a756a9a6c1e37fc39', 3347878015],
    ['e950be403efbf78c92e2bc647672ea52', 859512826],
    ['fe526b85aea85b14fb9a7de702504239', 2838499151],
    ['f3603de82a639dda33863e70b910ad82', 1402287040],
    ['42e1a9901fd629d6b39b62f7c2756188', 752452409],
    ['173af2c82fa90e5cfda61f36481fa26e', 2368356812],
    ['affd7b474332c4a009eea67d7a35b99a', 2668929024],
    ['45a106954a0917807774cdd2ed9f679e', 2504244057],
    ['29286287f1bf3dd3497bf728ff99363c', 1853201984],
    ['25468a1edfb4f50ea6aebf399fd0bd5d', 3280764276],
    ['bf293af17ef0a6b7a4adc559adfcdc95', 3364390282],
    ['bd19b04ed9648c4cea8ff8bab5c77180', 993375544],
    ['870d0687f13125ebce72023e7e84961f', 3335173965],
    ['151767899d51cb7549b1969b15c98214', 3560880243]
  ])('converts %s to %i', (traceId, expected) => {
    expect(traceIdToSamplingRate(traceId)).toBe(expected)
  })

  it.each(
    Array.from({ length: 128 }).map(() => randomBytes(16).toString('hex'))
  )('converts %s to an unsigned 32 bit integer', traceId => {
    const samplingRate = traceIdToSamplingRate(traceId)

    expect(samplingRate).toBeGreaterThanOrEqual(0)
    expect(samplingRate).toBeLessThanOrEqual(0xffffffff)
  })
})
